<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drawzy â€” Draw & Guess</title>
  <meta name="description"
    content="Free multiplayer drawing and guessing game. Create a room, invite friends, and let the fun begin!">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-pixel-grid">
  <div class="home-container">
    <main class="home-main">
      <!-- Logo -->
      <div class="logo-section">
        <h1 class="pixel-logo">DRAWZY</h1>
        <p class="tagline">DRAW â€¢ GUESS â€¢ WIN</p>
      </div>

      <!-- Player Setup Card -->
      <div class="pixel-border-chunky setup-card">
        <div class="setup-top">
          <!-- Avatar Column -->
          <div class="avatar-column">
            <div class="avatar-nav">
              <button class="pixel-button" id="prevAvatar" aria-label="Previous avatar">
                <span class="material-symbols-outlined">chevron_left</span>
              </button>
              <div class="avatar-frame" id="avatarCircle">
                <span class="avatar-emoji" id="avatarEmoji">ðŸ˜€</span>
                <img class="avatar-custom-img hidden" id="avatarCustomImg" alt="Custom avatar">
              </div>
              <button class="pixel-button" id="nextAvatar" aria-label="Next avatar">
                <span class="material-symbols-outlined">chevron_right</span>
              </button>
            </div>
            <div class="color-picker-grid">
              <button class="color-swatch active" data-color="#FFB085" style="background:#FFB085"></button>
              <button class="color-swatch" data-color="#F2789F" style="background:#F2789F"></button>
              <button class="color-swatch" data-color="#8D8078" style="background:#8D8078"></button>
              <button class="color-swatch" data-color="#4A403A" style="background:#4A403A"></button>
              <button class="color-swatch" data-color="#FFF5E4" style="background:#FFF5E4"></button>
              <button class="color-swatch" data-color="#EE6983" style="background:#EE6983"></button>
              <button class="color-swatch" data-color="#CBE4F9" style="background:#CBE4F9"></button>
              <button class="color-swatch" data-color="#CDF0EA" style="background:#CDF0EA"></button>
            </div>
          </div>

          <!-- Form Column -->
          <div class="form-column">
            <label for="nameInput">PLAYER NAME</label>
            <input type="text" id="nameInput" class="pixel-input" placeholder="Enter your name" maxlength="12"
              autocomplete="off" spellcheck="false">
            <button class="pixel-button pixel-button-grey" id="btnDrawAvatar" style="height:56px;">
              <span class="material-symbols-outlined" style="margin-right:12px;">brush</span> DRAW AVATAR
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-grid">
          <button class="pixel-button" id="btnPlay">
            <span class="material-symbols-outlined" style="margin-right:12px;">play_arrow</span> QUICK START
          </button>
          <button class="pixel-button pixel-button-secondary" id="btnCreateRoom">
            <span class="material-symbols-outlined" style="margin-right:12px;">sports_esports</span> PRIVATE LOBBY
          </button>
        </div>

        <!-- Join Section -->
        <div class="join-section">
          <p class="join-label">ALREADY HAVE A CODE?</p>
          <div class="join-row">
            <input type="text" id="roomCodeInput" class="pixel-input" placeholder="Enter code" maxlength="6"
              autocomplete="off" spellcheck="false">
            <button class="pixel-button" id="btnJoinRoom">JOIN</button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="home-footer">
        <div class="footer-links">
          <span>HOW TO PLAY</span>
          <span>SETTINGS</span>
        </div>
        <p>BUILT WITH PIXELS</p>
      </footer>
    </main>

    <!-- Error toast -->
    <div class="toast hidden" id="errorToast">
      <span id="errorMessage"></span>
    </div>

    <!-- Avatar Drawing Modal -->
    <div class="avatar-modal-overlay hidden" id="avatarModalOverlay">
      <div class="pixel-border-chunky avatar-modal">
        <div class="avatar-modal-header">
          <h2>PIXEL EDITOR</h2>
          <button class="avatar-modal-close" id="avCancel">&times;</button>
        </div>
        <div class="avatar-canvas-container">
          <div class="pixel-border-chunky avatar-canvas-frame">
            <canvas id="avatarCanvas" width="96" height="96"></canvas>
          </div>
        </div>
        <div class="avatar-toolbar">
          <div class="avatar-palette">
            <button class="color-swatch active" data-color="#000000" style="background:#000000"></button>
            <button class="color-swatch" data-color="#FFFFFF" style="background:#FFFFFF"></button>
            <button class="color-swatch" data-color="#FFB085" style="background:#FFB085"></button>
            <button class="color-swatch" data-color="#F2789F" style="background:#F2789F"></button>
            <button class="color-swatch" data-color="#8D8078" style="background:#8D8078"></button>
            <button class="color-swatch" data-color="#4A403A" style="background:#4A403A"></button>
            <button class="color-swatch" data-color="#FF0000" style="background:#FF0000"></button>
            <button class="color-swatch" data-color="#00FF00" style="background:#00FF00"></button>
            <button class="color-swatch" data-color="#0000FF" style="background:#0000FF"></button>
          </div>
          <div class="avatar-tools-row">
            <button class="pixel-button pixel-button-grey" id="avBrush">
              <span class="material-symbols-outlined">brush</span>
            </button>
            <button class="pixel-button pixel-button-grey" id="avEraser">
              <span class="material-symbols-outlined">ink_eraser</span>
            </button>
            <button class="pixel-button pixel-button-grey" id="avFill">
              <span class="material-symbols-outlined">colors</span>
            </button>
            <button class="pixel-button pixel-button-grey" id="avUndo">
              <span class="material-symbols-outlined">undo</span>
            </button>
            <button class="pixel-button pixel-button-grey" id="avClear">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
          <div class="avatar-tools-row">
            <button class="av-size active" data-size="1"><span class="av-size-dot"
                style="width:4px;height:4px"></span></button>
            <button class="av-size" data-size="2"><span class="av-size-dot"
                style="width:6px;height:6px"></span></button>
            <button class="av-size" data-size="4"><span class="av-size-dot"
                style="width:10px;height:10px"></span></button>
            <button class="av-size" data-size="6"><span class="av-size-dot"
                style="width:14px;height:14px"></span></button>
          </div>
          <div class="avatar-modal-actions">
            <button class="pixel-button pixel-button-grey" id="avResetToEmoji">BACK</button>
            <button class="pixel-button" id="avSave">SAVE</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ AVATAR SYSTEM ============
    const avatarEmojis = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ˜ˆ', 'ðŸ‘»', 'ðŸ¤–', 'ðŸ‘½', 'ðŸ¦Š', 'ðŸ±', 'ðŸ¶', 'ðŸ¸', 'ðŸ¦„', 'ðŸ§', 'ðŸ¼', 'ðŸ¦‹', 'ðŸ²', 'ðŸŽƒ'];
    let currentAvatarIndex = 0;
    let currentColor = '#FFB085';
    let customAvatarData = null;

    const avatarEmoji = document.getElementById('avatarEmoji');
    const avatarCircle = document.getElementById('avatarCircle');

    document.getElementById('prevAvatar').addEventListener('click', () => {
      currentAvatarIndex = (currentAvatarIndex - 1 + avatarEmojis.length) % avatarEmojis.length;
      avatarEmoji.textContent = avatarEmojis[currentAvatarIndex];
    });

    document.getElementById('nextAvatar').addEventListener('click', () => {
      currentAvatarIndex = (currentAvatarIndex + 1) % avatarEmojis.length;
      avatarEmoji.textContent = avatarEmojis[currentAvatarIndex];
    });

    document.querySelectorAll('.color-picker-grid .color-swatch').forEach(dot => {
      dot.addEventListener('click', () => {
        document.querySelectorAll('.color-picker-grid .color-swatch').forEach(d => d.classList.remove('active'));
        dot.classList.add('active');
        currentColor = dot.dataset.color;
        avatarCircle.style.background = currentColor;
      });
    });

    // Set initial avatar background color
    avatarCircle.style.background = currentColor;

    // ============ HELPERS ============
    function showError(msg) {
      const toast = document.getElementById('errorToast');
      document.getElementById('errorMessage').textContent = msg;
      toast.classList.remove('hidden');
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('show');
      }, 3000);
    }

    function getPlayerData() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) {
        showError('Please enter a name!');
        return null;
      }
      const avatarObj = {
        emoji: avatarEmojis[currentAvatarIndex],
        color: currentColor
      };
      if (customAvatarData) {
        avatarObj.customImage = customAvatarData;
      }
      return { name, avatar: avatarObj };
    }

    // ============ ACTIONS ============
    document.getElementById('btnPlay').addEventListener('click', () => {
      const data = getPlayerData();
      if (!data) return;
      sessionStorage.setItem('playerData', JSON.stringify(data));
      sessionStorage.setItem('gameAction', 'create');
      window.location.href = '/game';
    });

    document.getElementById('btnCreateRoom').addEventListener('click', () => {
      const data = getPlayerData();
      if (!data) return;
      sessionStorage.setItem('playerData', JSON.stringify(data));
      sessionStorage.setItem('gameAction', 'create');
      window.location.href = '/game';
    });

    document.getElementById('btnJoinRoom').addEventListener('click', () => {
      const data = getPlayerData();
      if (!data) return;
      const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
      if (!code) {
        showError('Please enter a room code!');
        return;
      }
      sessionStorage.setItem('playerData', JSON.stringify(data));
      sessionStorage.setItem('gameAction', 'join');
      sessionStorage.setItem('joinCode', code);
      window.location.href = `/game?room=${code}`;
    });

    document.getElementById('roomCodeInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btnJoinRoom').click();
    });

    document.getElementById('nameInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btnPlay').click();
    });

    document.getElementById('roomCodeInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    // ============ AVATAR DRAWING MODAL ============
    const avCanvas = document.getElementById('avatarCanvas');
    const avCtx = avCanvas.getContext('2d');
    let avDrawing = false;
    let avColor = '#000000';
    let avSize = 1;
    let avTool = 'brush'; // brush | eraser | fill
    let avLastX = 0, avLastY = 0;
    let avHistory = []; // canvas snapshots for undo

    function avSaveSnapshot() {
      avHistory.push(avCtx.getImageData(0, 0, avCanvas.width, avCanvas.height));
    }

    function avClear() {
      avCtx.fillStyle = '#FFFFFF';
      avCtx.fillRect(0, 0, avCanvas.width, avCanvas.height);
    }
    avClear();

    // Open modal
    document.getElementById('btnDrawAvatar').addEventListener('click', () => {
      document.getElementById('avatarModalOverlay').classList.remove('hidden');
      if (!customAvatarData) avClear();
    });

    // Close modal
    document.getElementById('avCancel').addEventListener('click', () => {
      document.getElementById('avatarModalOverlay').classList.add('hidden');
    });

    // Save avatar
    document.getElementById('avSave').addEventListener('click', () => {
      customAvatarData = avCanvas.toDataURL('image/png');
      const img = document.getElementById('avatarCustomImg');
      img.src = customAvatarData;
      img.classList.remove('hidden');
      document.getElementById('avatarEmoji').classList.add('hidden');
      document.getElementById('avatarModalOverlay').classList.add('hidden');
    });

    // Reset to emoji
    document.getElementById('avResetToEmoji').addEventListener('click', () => {
      customAvatarData = null;
      document.getElementById('avatarCustomImg').classList.add('hidden');
      document.getElementById('avatarEmoji').classList.remove('hidden');
      avClear();
      avHistory = [];
      document.getElementById('avatarModalOverlay').classList.add('hidden');
    });

    // Clear canvas
    document.getElementById('avClear').addEventListener('click', () => {
      avSaveSnapshot();
      avClear();
    });

    // Undo
    document.getElementById('avUndo').addEventListener('click', () => {
      if (avHistory.length === 0) return;
      avCtx.putImageData(avHistory.pop(), 0, 0);
    });

    // Avatar palette colors
    document.querySelectorAll('.avatar-palette .color-swatch').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.avatar-palette .color-swatch').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        avColor = btn.dataset.color;
        if (avTool === 'eraser') {
          avTool = 'brush';
          document.getElementById('avBrush').classList.add('active');
          document.getElementById('avEraser').classList.remove('active');
        }
      });
    });

    // Sizes
    document.querySelectorAll('.av-size').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.av-size').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        avSize = parseInt(btn.dataset.size);
      });
    });

    // Tools
    function setAvTool(tool) {
      avTool = tool;
      document.getElementById('avBrush').classList.toggle('active', tool === 'brush');
      document.getElementById('avEraser').classList.toggle('active', tool === 'eraser');
      document.getElementById('avFill').classList.toggle('active', tool === 'fill');
    }
    document.getElementById('avBrush').addEventListener('click', () => setAvTool('brush'));
    document.getElementById('avEraser').addEventListener('click', () => setAvTool('eraser'));
    document.getElementById('avFill').addEventListener('click', () => setAvTool('fill'));

    // Drawing on avatar canvas
    function avGetCoords(e) {
      const rect = avCanvas.getBoundingClientRect();
      const scaleX = avCanvas.width / rect.width;
      const scaleY = avCanvas.height / rect.height;
      let cx, cy;
      if (e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
      else { cx = e.clientX; cy = e.clientY; }
      return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
    }

    // Flood fill for avatar canvas
    function avFloodFill(startX, startY, fillColor) {
      const w = avCanvas.width, h = avCanvas.height;
      const imageData = avCtx.getImageData(0, 0, w, h);
      const data = imageData.data;
      const sx = Math.floor(startX), sy = Math.floor(startY);
      if (sx < 0 || sx >= w || sy < 0 || sy >= h) return;
      const tIdx = (sy * w + sx) * 4;
      const tR = data[tIdx], tG = data[tIdx + 1], tB = data[tIdx + 2];
      const fR = parseInt(fillColor.slice(1, 3), 16);
      const fG = parseInt(fillColor.slice(3, 5), 16);
      const fB = parseInt(fillColor.slice(5, 7), 16);
      if (tR === fR && tG === fG && tB === fB) return;
      const tolerance = 30;
      const stack = [[sx, sy]];
      const visited = new Set();
      while (stack.length > 0) {
        const [x, y] = stack.pop();
        const key = y * w + x;
        if (visited.has(key)) continue;
        if (x < 0 || x >= w || y < 0 || y >= h) continue;
        const idx = key * 4;
        if (Math.abs(data[idx] - tR) > tolerance || Math.abs(data[idx + 1] - tG) > tolerance || Math.abs(data[idx + 2] - tB) > tolerance) continue;
        visited.add(key);
        data[idx] = fR; data[idx + 1] = fG; data[idx + 2] = fB; data[idx + 3] = 255;
        stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
      }
      avCtx.putImageData(imageData, 0, 0);
    }

    avCanvas.addEventListener('mousedown', (e) => {
      const c = avGetCoords(e);
      if (avTool === 'fill') {
        avSaveSnapshot();
        avFloodFill(c.x, c.y, avColor);
        return;
      }
      avSaveSnapshot();
      avDrawing = true;
      avLastX = c.x; avLastY = c.y;
      const col = avTool === 'eraser' ? '#FFFFFF' : avColor;
      const sz = avTool === 'eraser' ? avSize * 2 : avSize;
      avCtx.beginPath();
      avCtx.arc(c.x, c.y, sz / 2, 0, Math.PI * 2);
      avCtx.fillStyle = col;
      avCtx.fill();
    });

    avCanvas.addEventListener('mousemove', (e) => {
      if (!avDrawing) return;
      const c = avGetCoords(e);
      const col = avTool === 'eraser' ? '#FFFFFF' : avColor;
      const sz = avTool === 'eraser' ? avSize * 2 : avSize;
      avCtx.beginPath();
      avCtx.moveTo(avLastX, avLastY);
      avCtx.lineTo(c.x, c.y);
      avCtx.strokeStyle = col;
      avCtx.lineWidth = sz;
      avCtx.lineCap = 'round';
      avCtx.stroke();
      avLastX = c.x; avLastY = c.y;
    });

    avCanvas.addEventListener('mouseup', () => { avDrawing = false; });
    avCanvas.addEventListener('mouseleave', () => { avDrawing = false; });

    // Touch support
    avCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); avCanvas.dispatchEvent(new MouseEvent('mousedown', { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY })); });
    avCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); avCanvas.dispatchEvent(new MouseEvent('mousemove', { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY })); });
    avCanvas.addEventListener('touchend', (e) => { e.preventDefault(); avCanvas.dispatchEvent(new MouseEvent('mouseup')); });
  </script>
</body>

</html>